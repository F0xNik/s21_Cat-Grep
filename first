#include <stdio.h>
#include <string.h>
#include <stdlib.h>

void cat(char input[100]);
void output_file(FILE *file, int flag);
int func_choice (char input[100]);
int check_count_file (char input[100], int k_str);
int flag_check(char input[100], int k_str);
//int check_outfile(char input[30]);
//int out_in_file(char path_start[30], char path_end[30]);

int main() {
    char input[100];
    fgets(input,100,stdin);
    //scanf("%s", input);
    do {
        if (func_choice(input) == 3) {
            printf("Unknown function\n");
            fseek(stdin,0,SEEK_END);
            scanf("%s", input);
        }
        if (func_choice(input) == 1) {
            cat(input);
        }
        if (func_choice(input) == 2) {
            printf("grep\n");
        }
    } while (func_choice(input) != 1 && func_choice(input) != 2);
}

int func_choice (char input[100]) {
    int result = 3;
    if (input[0] == 'c' && input[1]=='a' && input[2]=='t')  //функция чекающая кэт или грэп 
        result = 1;
    if (input[0] == 'g' && input[1]=='r' && input[2]=='e'
    && input[3] == 'p')
        result = 2;
    return result;
}

void output_file(FILE *file, int flag) {
    char output[250];  //вывод с учетом флагов 
    int schet = 1;
    int end = 1;
    int flag_out = flag;
    int i = 0;
    int fl_b = 0, fl_E = 0, fl_n = 0, fl_s = 9, fl_T = 0;
    while (flag_out != 0) {
        switch (flag_out % 10) //это сделано для работы с несколькими флагами
        {
        case 1:
            fl_b = 1;
            break;
        case 2:
            fl_E = 1;
            break;
        case 3:
            fl_n = 1;
            break;
        case 4:
            fl_s = 1;
            break;
        case 5:
            fl_T = 1;
            break;
        }
        flag_out /= 10;
    }
    int ch = 0;
    ch = 0;
    int first_empty = 0;
    int j = 0;
    while (end == 1) {
            fgets(output, 250, file);
            first_empty++;
            if (output[0] == '\0'||(int)output[0]==1) {
                end = 0;
                if (first_empty == 1)
                    ch = 1;
            }
            else {
                if (fl_b == 1 && output[0] != '\n' && output[0] != '\0') {
                    printf("%d ",schet);
                    schet++;
                }
                if (fl_n == 1 && output[0] != '\0') {
                    if (!(fl_s == 1 && output[0]=='\n')){
                        printf("%d ",schet);
                    }
                    schet++;
                }
                if(fl_E == 1) {
                    i = 0;
                    while (output[i]!= '\0' && output[i]!='\n') {
                        i++;
                    }
                    if (output[i]=='\n'){
                        output[i] = '\0';
                        strcat(output,"$\n");
                    }
                    else {
                        strcat(output,"$");
                    }
                }
                char sav_simb, sav_simb2;
                if (fl_T == 1) {
                    i=0;
                    while(output[i] != '\0' && output[i] != '\n'){
                        //printf("%d ",(int)output[i]);
                        if ((int)output[i] == 9) {
                            output[i]='^';
                            sav_simb = output[i+1];
                            output[i+1] = 'I';
                            i++;
                            j=i+1;
                            while(output[j] != '\0' && output[j] != '\n'){
                                //printf("%c",output[j]);
                                sav_simb2 = output[j];
                                output[j]=sav_simb;
                                sav_simb = sav_simb2;
                                j++;
                                //if(output[j] != '\0' && output[j] != '\n')
                                    //j--;
                            }
                            output[j+1]=output[j];
                            output[j]=sav_simb2;
                            //printf("#%c#",output[j]);
                        }
                        i++;
                    }
                }
                //printf("\n");
                if (end == 1) {
                    if (!(fl_s == 1 && output[0]=='\n'))
                        printf("%s",output);
                }
                //memset(output, 0, sizeof(char));
            }
            memset(output, 0, sizeof(char));
    }
    if (ch == 0)
        printf("\n");
}

int check_count_file (char input[100], int k_str) { //считает количество файлов(cat file - 1 файл, cat file file2 -2 файла)
    int count = 0;
    k_str--;
    while ( input[k_str] != '\0') {
        if (input[k_str] == ' ')
            count++;
        if (input[k_str] != ' ' && (input[k_str+1] == ' ' || input[k_str+1] == '\0' || input[k_str+1] == '\n'))
            count++;
        k_str++;
    }
    return count / 2;
}
int flag_check(char input[100], int k_str) {
    int int_flag;
    switch (input[k_str])
    {
    case 'b':
        int_flag = 1;
        break;
    case 'E':
        int_flag = 2;
        break;
    case 'n':
        int_flag = 3;
        break;
    case 's':
        int_flag = 4;
        break;
    case 'T':
        int_flag = 5;
        break;
    case 'h':
        int_flag = 6;
        break;
    case 'v':
        int_flag = 7;
        break; 
    default:
        int_flag = -1;
        break;
    }
    return int_flag;
}

void cat(char input[100]) {
    char path[20];
    int kount_str = 4;
    int clon_count_file = 0;
    int letter = 0;
    int flag = 0;
    int i = 0;
    int flag_count=1;
    int eror = 0;
    FILE *file;
    //check_outfile(input);
        while(input[kount_str] == '-') {        //сделано с учетом многофлажности, когда находится флаг число 
        flag *= flag_count;                     // умножается на 10 и прибавляется новое число
        if (flag_check(input, kount_str+1) == -1 || flag_check(input, kount_str+1) == 6 || flag_check(input, kount_str+1) == 7) {
            printf("Unknown flag\n",input[kount_str+1]);
            eror = 1;
            kount_str++;
            flag += flag_check(input, kount_str);       // фактически каждый новый флаг просто записывается справа
        }
        else {
        flag += flag_check(input, kount_str+1);
        kount_str += 3;
        flag_count = 10;
        }
    }
    clon_count_file = check_count_file(input, kount_str);
    if (eror == 1) {
        clon_count_file = 0;
    }
    for (i = 0; i < clon_count_file; i++) {
        while(input[kount_str]!='\n' && input[kount_str] != ' '&& input[kount_str]!='\0') {
            path[letter] = input[kount_str];
            letter++;
            kount_str++;
        }
        kount_str++;
        path[letter]='\0';
        letter = 0;
        file = fopen(path, "r");
        if (file == NULL) {
            printf("Eror with file number %d\n",i+1);
        }
        else {
            output_file(file, flag);
        }
        fclose(file);
    }
}
